import { SlashCommandBuilder } from "@discordjs/builders";

const inch = 0.0254;
const pound = 453.59237;
const fluidOunces = 0.0295735;

/**
 * A length unit used for unit conversion
 * @typedef {object} LengthUnit
 * @property {string} symbol The symbol of a unit
 * @property {Array<string>} names User-friendly names of the unit
 * @property {number} multiplier The multiplier relative to the base unit (which
 *  has this property set to 1)
 */

// Each base unit is an object inside each system.
// Each base unit contains its conversion function which converts to the opposite base unit (like metric to imperial).
// And the units of the base unit.

const imperialUnits = {
	fahrenheit: {
		convert: sum => prefixUnit([metricUnits.celsius.units[0]], (sum - 32) * (5 / 9)),
		units: [
			{
				symbol: 'F',
				names: ['fahrenheit', '째F', 'f'],
				multiplier: 1
			}
		]
	},
	rankine: {
		convert: sum => prefixUnit([metricUnits.celsius.units[0]], (sum - 491.67) * (5 / 9)),
		units: [
			{
				symbol: 'R',
				names: ['rankine', '째R', 'r'],
				multiplier: 1
			}
		]
	},
	volume: {
		convert: sum => simpleConvert(sum, fluidOunces, metricUnits.volume, ['l', 'ml']),
		units: [
			{
				symbol: 'fl oz',
				names: ['fluid ounce', 'fluid ounces'],
				multiplier: 1
			},
			{
				symbol: 'gi',
				names: ['gill', 'gills'],
				multiplier: 5
			},
			{
				symbol: 'pt',
				names: ['pint', 'pints'],
				multiplier: 20
			},
			{
				symbol: 'qt',
				names: ['quart', 'quarts'],
				multiplier: 40
			},
			{
				symbol: 'gal',
				names: ['gallon', 'US gallons', 'US gallon', 'American gallon', 'American gallons', 'gallons'],
				multiplier: 128
			},
			{
				symbol: 'impgal',
				names: ['imperial gallon', 'imperial gallons'],
				multiplier: 160
			}
		]
	},
	mass: {
		convert: sum => simpleConvert(sum, pound, metricUnits.mass, ['kg', 'g', 'Mg']),
		units: [
			{
				symbol: 'gr',
				names: ['grain', 'grains'],
				multiplier: 1 / 7000
			},
			{
				symbol: 'dr',
				names: ['drachm', 'drachms'],
				multiplier: 1 / 256
			},
			{
				symbol: 'oz',
				names: ['ounce', 'ounces'],
				multiplier: 1 / 16
			},
			{
				symbol: 'lb',
				names: ['pound', 'pounds', 'lbs'],
				multiplier: 1
			},
			{
				symbol: 'st',
				names: ['stone', 'stones'],
				multiplier: 14
			},
			{
				symbol: 'qtr',
				names: ['quarter', 'quarters'],
				multiplier: 28
			},
			{
				symbol: 'cwt',
				names: ['hundredweight', 'hundredweights'],
				multiplier: 112
			},
			{
				symbol: 't',
				names: ['ton', 'tons'],
				multiplier: 2240
			}
		]
	},
	length: {
		convert: sum => simpleConvert(sum, inch, metricUnits.length, ['km', 'm', 'cm', 'mm']),
		units: [
			{
				symbol: 'in',
				names: ['inch', 'inches', '"'],
				multiplier: 1
			},
			{
				symbol: 'ft',
				names: ['foot', 'feet', 'foots', 'feets', '\''],
				multiplier: 12
			},
			{
				symbol: 'yd',
				names: ['yard', 'yards'],
				multiplier: 12 * 3
			},
			{
				symbol: 'ch',
				names: ['chain', 'chains'],
				multiplier: 12 * 3 * 22
			},
			{
				symbol: 'fur',
				names: ['furlong', 'furlongs'],
				multiplier: 12 * 3 * 22 * 10
			},
			{
				symbol: 'mi',
				names: ['mile', 'miles'],
				multiplier: 12 * 3 * 22 * 10 * 8
			},
			{
				symbol: 'ftm',
				names: ['fathom', 'fathoms'],
				multiplier: 12 * 3 * 2.02667
			},
			{
				symbol: 'cable',
				names: ['cables'],
				multiplier: 12 * 3 * 2.02667 * 100
			},
			{
				symbol: 'nmi',
				names: ['nautical mile', 'nautical miles'],
				multiplier: 12 * 3 * 2.02667 * 100 * 10
			}
		]
	}
};

const metricUnits = {
	celsius: {
		convert: sum => prefixUnit([imperialUnits.fahrenheit.units[0]], (sum * (9 / 5)) + 32),
		units: [
			{
				symbol: 'C',
				names: ['c', '째C', 'celsius', 'centigrade', 'centigrades'],
				multiplier: 1
			}
		]
	},
	kalvin: {
		convert: sum => prefixUnit([imperialUnits.fahrenheit.units[0]], (sum * (9 / 5)) - 459.67),
		units: [
			{
				symbol: 'K',
				names: ['kelvin', '째K', 'kelvins', 'k'],
				multiplier: 1
			}
		]
	},
	volume: {
		convert: sum => simpleConvert(sum, 1 / fluidOunces, imperialUnits.volume, ['gal', 'fl oz']),
		units: [
			{
				symbol: 'ml',
				names: ['milliliter', 'milliliters', 'millilitre', 'millilitres', 'ML'],
				multiplier: 0.001
			},
			{
				symbol: 'cl',
				names: ['centiliter', 'centiliters', 'centilitre', 'centilitres'],
				multiplier: 0.01
			},
			{
				symbol: 'dl',
				names: ['deciliter', 'deciliters', 'decilitre', 'decilitres'],
				multiplier: 0.1
			},
			{
				symbol: 'l',
				names: ['liter', 'liters', 'litre', 'litres', 'L'],
				multiplier: 1
			},
			{
				symbol: 'dal',
				names: ['decaliter', 'decaliters', 'decalitre', 'decalitres'],
				multiplier: 10
			},
			{
				symbol: 'hl',
				names: ['hectoliter', 'hectoliters', 'hectomatre', 'hectolitres'],
				multiplier: 100
			},
			{
				symbol: 'kl',
				names: ['kiloliter', 'kiloliters', 'kilolitre', 'kilolitres'],
				multiplier: 1000
			}
		]
	},
	mass: {
		convert: sum => simpleConvert(sum, 1 / pound, imperialUnits.mass, ['oz', 'lb', 't']),
		units: [
			{
				symbol: 'mg',
				names: ['milligram', 'milligrams', 'milligramme', 'milligrammes'],
				multiplier: 0.001
			},
			{
				symbol: 'cg',
				names: ['centigram', 'centigrams', 'centigramme', 'centigrammes'],
				multiplier: 0.01
			},
			{
				symbol: 'dg',
				names: ['decigram', 'decigrams', 'decigramme', 'decigrammes'],
				multiplier: 0.1
			},
			{
				symbol: 'g',
				names: ['gram', 'grams', 'gramme', 'grammes'],
				multiplier: 1
			},
			{
				symbol: 'dag',
				names: ['decagram', 'decagrams', 'decagramme', 'decagrammes'],
				multiplier: 10
			},
			{
				symbol: 'hg',
				names: ['hectogram', 'hectograms', 'hectomatre', 'hectogrammes'],
				multiplier: 100
			},
			{
				symbol: 'kg',
				names: ['kilogram', 'kilograms', 'kilogramme', 'kilogrammes'],
				multiplier: 1000
			},
			// Officially, it's 'megagram'. However, ton/tonne is also used and since both imperial and metric use it,
			// 'Ton' will be imperial and 'Tonne' will be metric
			{
				symbol: 'Mg',
				names: [
					'metric ton', 'metric tons', 'megagram', 'megagrams', 'megagramme', 'megagrammes', 'tonne', 'tonnes', 'metric tonne', 'metric tonnes'
				],
				multiplier: 1000000
			}
		]
	},
	length: {
		convert: sum => {
			const inches = sum / inch;
			const displayedUnits = imperialUnits.length.units.filter(unit =>
				['mi', 'ft', 'in'].includes(unit.symbol)
			);

			// A special case to use the feet'inches" format when the number is
			// between 1 and 15 feet
			if (inches >= 12 && inches <= 180) {
				const rounded = Math.round(inches);
				return `${Math.floor(rounded / 12)}'${rounded % 12}"`;
			}

			return prefixUnit(displayedUnits, inches);
		},
		units: [
			{
				symbol: 'mm',
				names: ['millimeter', 'millimeters', 'millimetre', 'millimetres'],
				multiplier: 0.001
			},
			{
				symbol: 'cm',
				names: ['centimeter', 'centimeters', 'centimetre', 'centimetres'],
				multiplier: 0.01
			},
			{
				symbol: 'dm',
				names: ['decimeter', 'decimeters', 'decimetre', 'decimetres'],
				multiplier: 0.1
			},
			{
				symbol: 'm',
				names: ['meter', 'meters', 'metre', 'metres'],
				multiplier: 1
			},
			{
				symbol: 'dam',
				names: ['decameter', 'decameters', 'decametre', 'decametres'],
				multiplier: 10
			},
			{
				symbol: 'hm',
				names: ['hectometer', 'hectometers', 'hectomatre', 'hectometres'],
				multiplier: 100
			},
			{
				symbol: 'km',
				names: ['kilometer', 'kilometers', 'kilometre', 'kilometres'],
				multiplier: 1000
			}
		]
	}
};

const unitSystems = [...Object.values(imperialUnits), ...Object.values(metricUnits)];

/**
 * Deals with the conversion if it's simple enough.
 * @param {number} sum The sum that is calculated in exec.
 * @param {number} multiplier The number that should be multiplied to get the new unit.
 * @param {Object} baseUnit A base unit object that contains all units. Example: metricUnits.weight.
 * @param {Array<string>} specialUnits An array containing what kind of units should be shown as a result. This should contain non obscure units.
 * @returns {number} A user-friendly representation of the value
 */
function simpleConvert(sum, multiplier, baseUnit, specialUnits) {
	const result = sum * multiplier;
	const displayedUnits = baseUnit.units.filter(unit => specialUnits.includes(unit.symbol));

	return prefixUnit(displayedUnits, result);
}

/**
 * Convert a user-friendly name of a unit to the unit's symbol, eg.
 * "meters" -> "m", "meter" -> "m", "m" -> "m"
 * @param {Array<LengthUnit>} units An array of units to look up
 * @param {string} unitName A string to be matched
 * @returns {?string} The unit's symbol or null
 */
function getUnitSymbol(units, unitName) {
	const matchingUnit = units.find(
		unit => unit.symbol === unitName || unit.names.includes(unitName)
	);

	return matchingUnit ? matchingUnit.symbol : null;
}

/**
 * Execute a regular expression and return all matching values (a RegExp with
 * the global flag can match multiple values in a single string)
 * @param {RegExp} regexp A RegExp to match the string against
 * @param {string} text A string to be matched
 * @returns {Array} An array containing all results of RegExp#exec
 */
function getAllMatches(regexp, text) {
	const results = [];
	let value;

	while ((value = regexp.exec(text)) !== null) {
		results.push(value);
	}

	return results;
}

/**
 * Parse user input containing length units and return them in a normalized
 * format of an array of [number, unit symbol]
 * @param {string} text User input
 * @param {Array<Array<LengthUnit>>} baseUnits All supported unit systems
 * @returns {Array<Array<number, string>>} An array of recognized units and values
 */
function parseUnits(text, baseUnits) {
	const allUnits = baseUnits.reduce((collectedUnits, baseUnit) => [...collectedUnits, ...baseUnit.units], []);
	const parts = getAllMatches(/(-?[\d,.]+)(?:\s?([^\d]+))?/g, text)
		.map(match => match.slice(1, 3))
		.map(part => ({
			value: parseFloat(
				/^[\d]+,[\d]+$/.test(part[0]) ?
					part[0].replace(',', '.') :
					part[0].replace(/,/g, ''),
				10
			),
			symbol: getUnitSymbol(allUnits, part[1])
		}));

	return parts;
}

/**
 * Convert a number in a base unit to a user-friendly (approximated) form,
 * eg. 20000 m -> 20 kilometers
 * @param {Array<LengthUnit>} units An array with possible units
 * @param {number} value The value in the base unit
 * @returns {string} A user-friendly representation of the value
 */
function prefixUnit(units, value) {
	const unit = units.reduce(
		(chosenUnit, currentUnit) =>
			currentUnit.multiplier <= Math.abs(value) ? currentUnit : chosenUnit
	);
	const length = value / unit.multiplier;

	return `${Math.round(length * 100) / 100} ${unit.names[1]}`;
}

export default {
    async execute(interaction) {
        const measurement = interaction.options.getString('measurement');
        const input = parseUnits(measurement, unitSystems);
        const baseUnit = unitSystems.find(({units}) => {
            return input.every(part => units.some(unit => unit.symbol === part.symbol));
        });
    
        if (input.length === 0 || !baseUnit) {
            // User's input is incomprehensible, give up
            interaction.reply(
                'There was an error processing your measurements.\n' +
                'Maybe you typed something like `5\'4` or `1m50`, these ' +
                'notations aren\'t supported, use `5\'4"` and `1.5m` instead.'
            );
            return;
        }

        // The unit is inches for imperial and meters for metric
        const sum = input.map(part => {
            const unit = baseUnit.units.find(unit => unit.symbol === part.symbol);
            return part.value * unit.multiplier;
        }).reduce((sum, number) => sum + number);

        const output = baseUnit.convert(sum);
    
        await interaction.reply(`${measurement} would be ${output}!`);
    },
    data: new SlashCommandBuilder()
        .setName('convert')
        .setDescription('A handy command to convert units from metric to imperial')
        .addStringOption(option => {
            option.setName('measurement').setRequired(true);
            option.setDescription('The measurement you wish to convert from');
            return option;
        })
};